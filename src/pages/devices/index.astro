---
export const prerender = false;

import DashboardLayout from "../../layouts/DashboardLayout.astro";
import ServerTable from "../../components/ServerTable.astro";
import DateFilter from "../../components/DateFilter.astro";
import { getDevicesPaginated, getDeviceMap, type QueryParams, type DateRange } from "../../lib/db";

// Parse URL params
const url = new URL(Astro.request.url);
const dateRange = (url.searchParams.get('range') as DateRange) || 'all';
const params: QueryParams = {
  page: parseInt(url.searchParams.get('page') || '1'),
  pageSize: Math.min(100, Math.max(10, parseInt(url.searchParams.get('pageSize') || '100'))),
  sort: url.searchParams.get('sort') || 'created_at',
  order: (url.searchParams.get('order') as 'asc' | 'desc') || 'desc',
  search: url.searchParams.get('search') || '',
  dateRange
};

// Fetch data with server-side pagination, sorting, search
const [result, deviceMap] = await Promise.all([
  getDevicesPaginated(params),
  getDeviceMap()
]);

// Create device name lookup
const deviceNames = new Map(deviceMap.map(d => [d.device_id, d.device_name]));

// Enrich devices with names
const enrichedDevices = result.data.map(d => ({
  ...d,
  device_name: deviceNames.get(d.device_id) || null,
}));

// Calculate stats from total (not just current page)
const premiumCount = result.data.filter(d => d.user_type === 'premium_user').length;

// Column definitions with render functions
const columns = [
  {
    key: 'device_id',
    label: 'Device ID',
    sortable: true,
    render: (value: string, row: any) => `
      <a href="/devices/${value}" class="font-mono text-xs hover:underline whitespace-nowrap">${value}</a>
      ${row.device_name ? `<p class="text-xs text-emerald-600 font-medium mt-0.5">${row.device_name}</p>` : ''}
    `
  },
  {
    key: 'user_type',
    label: 'User Type',
    sortable: true,
    render: (value: string) => {
      const isPremium = value === 'premium_user';
      const classes = isPremium 
        ? 'bg-emerald-500/10 text-emerald-600 border-emerald-500/20'
        : 'bg-gray-500/10 text-gray-600 border-gray-500/20';
      return `<span class="inline-flex items-center text-xs px-2 py-1 rounded-full border font-medium ${classes}">${value?.replace('_', ' ') || 'unknown'}</span>`;
    }
  },
  {
    key: 'images_limit',
    label: 'Images Limit',
    sortable: true,
    render: (value: number) => `
      <span class="text-sm font-semibold">${value}</span>
      <span class="text-xs text-muted-foreground ml-1">images</span>
    `
  },
  {
    key: 'created_at',
    label: 'Created',
    sortable: true,
    render: (value: number) => {
      const date = new Date(value * 1000);
      return `
        <p class="text-sm">${date.toLocaleDateString('en-IN', { dateStyle: 'medium', timeZone: 'Asia/Kolkata' })}</p>
        <p class="text-xs text-muted-foreground">${date.toLocaleTimeString('en-IN', { timeStyle: 'short', timeZone: 'Asia/Kolkata' })}</p>
      `;
    }
  },
  {
    key: 'device_id',
    label: 'Actions',
    sortable: false,
    render: (value: string) => `
      <a href="/devices/${value}" class="inline-flex items-center gap-1 text-sm font-medium hover:underline">
        View
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
        </svg>
      </a>
    `
  }
];
---

<DashboardLayout title="Devices" activePage="devices">
  <div class="space-y-6">
    <!-- Date Filter -->
    <div class="flex items-center justify-between">
      <DateFilter 
        baseUrl="/devices" 
        currentRange={dateRange}
        preserveParams={{ sort: params.sort || '', order: params.order || '', search: params.search || '' }}
      />
      <div class="text-sm text-muted-foreground">
        <span class="font-semibold text-foreground">{result.total.toLocaleString()}</span> devices
      </div>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="bg-card border border-border rounded-xl p-5">
        <p class="text-sm text-muted-foreground font-medium">Total Devices</p>
        <p class="text-3xl font-bold mt-1 tracking-tight">{result.total.toLocaleString()}</p>
      </div>
      <div class="bg-card border border-border rounded-xl p-5">
        <p class="text-sm text-muted-foreground font-medium">Named Devices</p>
        <p class="text-3xl font-bold mt-1 tracking-tight">{deviceMap.length}</p>
      </div>
      <div class="bg-card border border-border rounded-xl p-5">
        <p class="text-sm text-muted-foreground font-medium">Current Page</p>
        <p class="text-3xl font-bold mt-1 tracking-tight">{result.page} <span class="text-lg text-muted-foreground">/ {result.totalPages}</span></p>
      </div>
      <div class="bg-card border border-border rounded-xl p-5">
        <p class="text-sm text-muted-foreground font-medium">Page Size</p>
        <p class="text-3xl font-bold mt-1 tracking-tight">{result.pageSize}</p>
      </div>
    </div>

    <!-- Server-Side Table -->
    <ServerTable 
      data={enrichedDevices}
      columns={columns}
      total={result.total}
      page={result.page}
      pageSize={result.pageSize}
      totalPages={result.totalPages}
      sort={params.sort}
      order={params.order}
      search={params.search}
      baseUrl="/devices"
      searchPlaceholder="Search by device ID..."
    />
  </div>
</DashboardLayout>

