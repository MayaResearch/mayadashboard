---
export const prerender = false;

import DashboardLayout from "../../layouts/DashboardLayout.astro";
import DateFilter from "../../components/DateFilter.astro";
import { PremiumTable } from "../../components/tables/PremiumTable";
import { db, type DateRange } from "../../lib/db";

// Helper to get start of day in IST as Unix timestamp
function getStartOfDayIST(daysAgo: number = 0): number {
  const now = new Date();
  const formatter = new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    month: 'numeric',
    day: 'numeric',
    timeZone: 'Asia/Kolkata',
  });
  const parts = formatter.formatToParts(now);
  const year = parseInt(parts.find(p => p.type === 'year')?.value || '0');
  const month = parseInt(parts.find(p => p.type === 'month')?.value || '0');
  const day = parseInt(parts.find(p => p.type === 'day')?.value || '0');

  const targetDateIST = new Date(Date.UTC(year, month - 1, day - daysAgo, 0, 0, 0));
  const istOffsetMinutes = 5 * 60 + 30;
  targetDateIST.setUTCMinutes(targetDateIST.getUTCMinutes() - istOffsetMinutes);

  return Math.floor(targetDateIST.getTime() / 1000);
}

function getDateRangeTimestamp(range: DateRange): number | null {
  switch (range) {
    case 'today': return getStartOfDayIST(0);
    case '7days': return getStartOfDayIST(7);
    case '14days': return getStartOfDayIST(14);
    case '30days': return getStartOfDayIST(30);
    default: return null;
  }
}

// Parse URL params
const url = new URL(Astro.request.url);
const dateRange = (url.searchParams.get('range') as DateRange) || 'all';
const page = parseInt(url.searchParams.get('page') || '1');
const pageSize = Math.min(100, Math.max(10, parseInt(url.searchParams.get('pageSize') || '100')));
const sort = url.searchParams.get('sort') || 'updated_at';
const order = (url.searchParams.get('order') as 'asc' | 'desc') || 'desc';
const search = url.searchParams.get('search') || '';
const statusFilter = url.searchParams.get('status') || 'all'; // all, active, cancelled

// Build query - Join devices with device_map to get device names
const conditions: string[] = ["d.user_type = 'premium_user'"];
const args: any[] = [];

// Date filter
const fromTimestamp = getDateRangeTimestamp(dateRange);
if (fromTimestamp) {
  conditions.push('d.created_at >= ?');
  args.push(fromTimestamp);
}

// Search filter - search on device_id from devices table and device_name from device_map
if (search) {
  conditions.push('(d.device_id LIKE ? OR dm.device_name LIKE ?)');
  args.push(`%${search}%`, `%${search}%`);
}

// Get total count with join
const countResult = await db.execute({
  sql: `SELECT COUNT(*) as count FROM devices d LEFT JOIN device_map dm ON d.device_id = dm.device_id WHERE ${conditions.join(' AND ')}`,
  args
});
const total = countResult.rows[0].count as number;

// Validate sort column - prefix with table alias
const validSortColumns = ['device_id', 'created_at', 'updated_at', 'images_limit'];
const sortColumn = validSortColumns.includes(sort) ? `d.${sort}` : 'd.updated_at';
const sortOrder = order === 'asc' ? 'ASC' : 'DESC';

// Fetch paginated data with join - NO subscription fetch blocking here!
const offset = (page - 1) * pageSize;
const result = await db.execute({
  sql: `SELECT d.device_id, d.created_at, d.updated_at, d.user_type, dm.device_name 
        FROM devices d 
        LEFT JOIN device_map dm ON d.device_id = dm.device_id 
        WHERE ${conditions.join(' AND ')} 
        ORDER BY ${sortColumn} ${sortOrder} 
        LIMIT ? OFFSET ?`,
  args: [...args, pageSize, offset]
});

const premiumUsers = result.rows.map((row: any) => ({
  device_id: row.device_id,
  device_name: row.device_name || null,
  created_at: row.created_at,
  updated_at: row.updated_at,
}));

const totalPages = Math.ceil(total / pageSize);

// Build URL for status filter
function buildStatusUrl(status: string): string {
  const params = new URLSearchParams();
  if (status !== 'all') params.set('status', status);
  if (dateRange !== 'all') params.set('range', dateRange);
  if (sort !== 'updated_at') params.set('sort', sort);
  if (order !== 'desc') params.set('order', order);
  if (search) params.set('search', search);
  if (pageSize !== 100) params.set('pageSize', pageSize.toString());
  const queryString = params.toString();
  return `/premium${queryString ? '?' + queryString : ''}`;
}
---

<DashboardLayout title="Premium Users" activePage="premium">
  <div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg bg-amber-500/10 flex items-center justify-center">
          <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" />
          </svg>
        </div>
        <div>
          <h1 class="text-xl font-bold">Premium Users</h1>
          <p class="text-sm text-muted-foreground">
            {total.toLocaleString()} premium users
          </p>
        </div>
      </div>
      <DateFilter 
        baseUrl="/premium" 
        currentRange={dateRange}
        preserveParams={{ sort, order, search, pageSize: pageSize.toString(), status: statusFilter }}
      />
    </div>

    <!-- Subscription Status Filter -->
    <div class="flex items-center gap-2">
      <span class="text-sm text-muted-foreground">Subscription:</span>
      <div class="flex gap-1">
        <a 
          href={buildStatusUrl('all')}
          class:list={[
            "px-3 py-1.5 text-xs font-medium rounded-lg border transition-colors",
            statusFilter === 'all' 
              ? "bg-foreground text-background border-foreground" 
              : "bg-card text-muted-foreground border-border hover:bg-muted hover:text-foreground"
          ]}
        >
          All
        </a>
        <a 
          href={buildStatusUrl('active')}
          class:list={[
            "px-3 py-1.5 text-xs font-medium rounded-lg border transition-colors",
            statusFilter === 'active' 
              ? "bg-emerald-600 text-white border-emerald-600" 
              : "bg-emerald-500/10 text-emerald-600 border-emerald-500/20 hover:bg-emerald-500/20"
          ]}
        >
          Active
        </a>
        <a 
          href={buildStatusUrl('cancelled')}
          class:list={[
            "px-3 py-1.5 text-xs font-medium rounded-lg border transition-colors",
            statusFilter === 'cancelled' 
              ? "bg-red-600 text-white border-red-600" 
              : "bg-red-500/10 text-red-600 border-red-500/20 hover:bg-red-500/20"
          ]}
        >
          Cancelled
        </a>
      </div>
    </div>

    <!-- React Table with Client-Side Subscription Loading -->
    <PremiumTable 
      client:load
      users={premiumUsers}
      total={total}
      page={page}
      pageSize={pageSize}
      totalPages={totalPages}
      sort={sort}
      order={order}
      search={search}
      baseUrl="/premium"
      statusFilter={statusFilter}
    />
  </div>
</DashboardLayout>
