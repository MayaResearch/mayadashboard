---
export const prerender = false;

import DashboardLayout from "../../layouts/DashboardLayout.astro";
import ServerTable from "../../components/ServerTable.astro";
import DateFilter from "../../components/DateFilter.astro";
import { db, type DateRange } from "../../lib/db";

// Helper to get start of day in IST as Unix timestamp
function getStartOfDayIST(daysAgo: number = 0): number {
  const now = new Date();
  const formatter = new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    month: 'numeric',
    day: 'numeric',
    timeZone: 'Asia/Kolkata',
  });
  const parts = formatter.formatToParts(now);
  const year = parseInt(parts.find(p => p.type === 'year')?.value || '0');
  const month = parseInt(parts.find(p => p.type === 'month')?.value || '0');
  const day = parseInt(parts.find(p => p.type === 'day')?.value || '0');

  const targetDateIST = new Date(Date.UTC(year, month - 1, day - daysAgo, 0, 0, 0));
  const istOffsetMinutes = 5 * 60 + 30;
  targetDateIST.setUTCMinutes(targetDateIST.getUTCMinutes() - istOffsetMinutes);

  return Math.floor(targetDateIST.getTime() / 1000);
}

function getDateRangeTimestamp(range: DateRange): number | null {
  switch (range) {
    case 'today': return getStartOfDayIST(0);
    case '7days': return getStartOfDayIST(7);
    case '14days': return getStartOfDayIST(14);
    case '30days': return getStartOfDayIST(30);
    default: return null;
  }
}

// Parse URL params
const url = new URL(Astro.request.url);
const dateRange = (url.searchParams.get('range') as DateRange) || 'all';
const page = parseInt(url.searchParams.get('page') || '1');
const pageSize = Math.min(100, Math.max(10, parseInt(url.searchParams.get('pageSize') || '100')));
const sort = url.searchParams.get('sort') || 'updated_at';
const order = (url.searchParams.get('order') as 'asc' | 'desc') || 'desc';
const search = url.searchParams.get('search') || '';

// Build query
const conditions: string[] = ["user_type = 'premium_user'"];
const args: any[] = [];

// Date filter
const fromTimestamp = getDateRangeTimestamp(dateRange);
if (fromTimestamp) {
  conditions.push('created_at >= ?');
  args.push(fromTimestamp);
}

// Search filter
if (search) {
  conditions.push('(device_id LIKE ? OR device_name LIKE ?)');
  args.push(`%${search}%`, `%${search}%`);
}

// Get total count
const countResult = await db.execute({
  sql: `SELECT COUNT(*) as count FROM devices WHERE ${conditions.join(' AND ')}`,
  args
});
const total = countResult.rows[0].count as number;
const totalPages = Math.ceil(total / pageSize);

// Validate sort column
const validSortColumns = ['device_id', 'device_name', 'created_at', 'updated_at', 'images_limit'];
const sortColumn = validSortColumns.includes(sort) ? sort : 'updated_at';
const sortOrder = order === 'asc' ? 'ASC' : 'DESC';

// Fetch paginated data
const offset = (page - 1) * pageSize;
const result = await db.execute({
  sql: `SELECT * FROM devices WHERE ${conditions.join(' AND ')} ORDER BY ${sortColumn} ${sortOrder} LIMIT ? OFFSET ?`,
  args: [...args, pageSize, offset]
});

const premiumUsers = result.rows as any[];

// Column definitions
const columns = [
  {
    key: 'device_id',
    label: 'Device ID',
    sortable: true,
    render: (value: string) => `
      <a href="/devices/${value}" class="font-mono text-xs hover:underline text-blue-600 whitespace-nowrap">${value}</a>
    `
  },
  {
    key: 'device_name',
    label: 'Device Name',
    sortable: true,
    render: (value: string | null) => value 
      ? `<span class="text-sm font-medium">${value}</span>` 
      : `<span class="text-muted-foreground text-xs">Unnamed</span>`
  },
  {
    key: 'images_limit',
    label: 'Images Limit',
    sortable: true,
    render: (value: number) => `<span class="text-sm font-semibold">${value.toLocaleString()}</span>`
  },
  {
    key: 'created_at',
    label: 'Created',
    sortable: true,
    render: (value: number) => {
      const date = new Date(value * 1000);
      return `
        <p class="text-sm">${date.toLocaleDateString('en-IN', { dateStyle: 'short', timeZone: 'Asia/Kolkata' })}</p>
        <p class="text-xs text-muted-foreground">${date.toLocaleTimeString('en-IN', { timeStyle: 'short', timeZone: 'Asia/Kolkata' })}</p>
      `;
    }
  },
  {
    key: 'updated_at',
    label: 'Last Active',
    sortable: true,
    render: (value: number) => {
      const date = new Date(value * 1000);
      return `
        <p class="text-sm">${date.toLocaleDateString('en-IN', { dateStyle: 'short', timeZone: 'Asia/Kolkata' })}</p>
        <p class="text-xs text-muted-foreground">${date.toLocaleTimeString('en-IN', { timeStyle: 'short', timeZone: 'Asia/Kolkata' })}</p>
      `;
    }
  }
];
---

<DashboardLayout title="Premium Users" activePage="premium">
  <div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg bg-amber-500/10 flex items-center justify-center">
          <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" />
          </svg>
        </div>
        <div>
          <h1 class="text-xl font-bold">Premium Users</h1>
          <p class="text-sm text-muted-foreground">{total.toLocaleString()} premium users</p>
        </div>
      </div>
      <DateFilter 
        baseUrl="/premium" 
        currentRange={dateRange}
        preserveParams={{ sort, order, search, pageSize: pageSize.toString() }}
      />
    </div>

    <!-- Server-Side Table -->
    <ServerTable 
      data={premiumUsers}
      columns={columns}
      total={total}
      page={page}
      pageSize={pageSize}
      totalPages={totalPages}
      sort={sort}
      order={order}
      search={search}
      baseUrl="/premium"
      searchPlaceholder="Search by device ID or name..."
    />
  </div>
</DashboardLayout>

